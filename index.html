<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TherMix - Professional Lab Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F9FAFB; }
        .bg-navy { background-color: #30486D; }
        .text-navy { color: #30486D; }
        .bg-scientific { background-color: #4C74A9; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(229, 231, 235, 1); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        @media print { .no-print { display: none !important; } body { background: white; } }
    </style>
</head>
<body class="text-gray-900 antialiased">

    <nav class="bg-navy text-white px-6 py-4 flex justify-between items-center shadow-xl sticky top-0 z-50 no-print">
        <div class="flex items-center gap-3" onclick="showPage('dashboard')" style="cursor:pointer">
            <svg class="w-8 h-8 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            <span class="text-xl font-extrabold tracking-tight">TherMix</span>
        </div>
        <div class="flex items-center gap-6">
            <button onclick="showPage('dashboard')" class="hover:text-blue-200 font-medium">Protocols</button>
            <button onclick="showPage('import')" class="bg-scientific px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-opacity-90 transition">Smart Import</button>
        </div>
    </nav>

    <div id="main-content" class="container mx-auto p-6 max-w-7xl"></div>

    <script>
        // --- State Management ---
        let state = {
            currentPage: 'dashboard',
            isAILoading: false,
            protocols: [],
            editingProtocol: null
        };

        const defaultProtocol = {
            id: 'p1',
            title: 'SARS-CoV-2 Detection (N1)',
            description: 'Standard CDC-approved diagnostic protocol.',
            updated: '2023-10-24',
            numSamples: 10,
            sampleVolume: 5.0,
            reagents: [
                { name: 'Nuclease-free Water', perSample: 5.5, unit: 'µL' },
                { name: 'TaqPath Master Mix', perSample: 12.5, unit: 'µL' },
                { name: 'N1 Primers/Probes', perSample: 1.5, unit: 'µL' }
            ],
            thermalSteps: [
                { name: 'Reverse Transcription', temp: 50, duration: '15m', cycles: 1 },
                { name: 'Initial Denaturation', temp: 95, duration: '2m', cycles: 1 },
                { name: 'Denaturation', temp: 95, duration: '3s', cycles: 45 },
                { name: 'Anneal & Extend', temp: 55, duration: '30s', cycles: 45 }
            ]
        };

        // --- Persistence ---
        function saveToLocal() {
            localStorage.setItem('molecular_protocols_v2', JSON.stringify(state.protocols));
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('molecular_protocols_v2');
            state.protocols = saved ? JSON.parse(saved) : [defaultProtocol];
        }

        // --- AI API Logic ---
        async function callGemini(prompt, isJson = false) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates[0].content) {
                    let text = result.candidates[0].content.parts[0].text;
                    if (isJson) {
                        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        return JSON.parse(text);
                    }
                    return text;
                }
                throw new Error("Invalid response");
            } catch (error) {
                console.error("AI Error:", error);
                return null;
            }
        }

        // --- Navigation ---
        function showPage(page) {
            state.currentPage = page;
            render();
        }

        // --- UI Rendering ---
        function render() {
            const content = document.getElementById('main-content');
            if (state.currentPage === 'dashboard') renderDashboard(content);
            else if (state.currentPage === 'editor') renderEditor(content);
            else if (state.currentPage === 'import') renderImport(content);
        }

        function renderDashboard(container) {
            container.innerHTML = `
                <div class="mb-10 flex justify-between items-center">
                    <h1 class="text-4xl font-extrabold text-navy">Protocols</h1>
                    <button onclick="createNewProtocol()" class="bg-navy text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:brightness-110 transition">+ New</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${state.protocols.map(p => `
                        <div class="glass-card rounded-2xl p-6 hover:shadow-xl transition-all border-l-4 border-navy flex flex-col justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-navy mb-2">${p.title}</h3>
                                <p class="text-sm text-gray-500 mb-6">${p.description}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editProtocol('${p.id}')" class="flex-grow bg-gray-100 text-navy py-2 rounded-lg font-bold text-sm hover:bg-gray-200">Open</button>
                                <button onclick="deleteProtocol('${p.id}')" class="px-3 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition">✕</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderImport(container) {
            container.innerHTML = `
                <div class="max-w-xl mx-auto bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h2 class="text-2xl font-black text-navy text-center mb-6">Smart AI Import</h2>
                    <div class="border-2 border-dashed border-blue-100 rounded-2xl p-8 text-center bg-blue-50/30 mb-6 relative hover:bg-blue-50 transition">
                        <input type="file" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileUpload(event)">
                        <span class="text-navy font-bold block" id="file-status">Click to upload PDF</span>
                    </div>
                    <textarea id="importText" class="w-full h-40 p-4 border rounded-2xl focus:ring-2 focus:ring-navy outline-none mb-4 text-sm" placeholder="Paste text here..."></textarea>
                    <button onclick="runSmartImport()" class="w-full bg-navy text-white py-4 rounded-2xl font-black shadow-lg">
                        ${state.isAILoading ? '⏳ Processing...' : 'Start AI Import ✨'}
                    </button>
                </div>
            `;
        }

        // --- Core Logic ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const status = document.getElementById('file-status');
            status.innerText = "⏳ Extracting PDF...";

            const reader = new FileReader();
            reader.onload = async function() {
                try {
                    const pdfjsLib = window['pdfjs-dist/build/pdf'];
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                    let text = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(s => s.str).join(" ") + "\n";
                    }
                    document.getElementById('importText').value = text;
                    status.innerText = "✅ PDF Loaded!";
                } catch (e) { status.innerText = "❌ PDF Error"; }
            };
            reader.readAsArrayBuffer(file);
        }

        async function runSmartImport() {
            const text = document.getElementById('importText').value;
            if (!text) return alert("Please enter text");

            state.isAILoading = true;
            render();

            const prompt = `Extract chemical protocols from text. Return JSON Array of objects: [{"title": "Name", "description": "Info", "sampleVolume": 2.0, "reagents": [{"name": "X", "perSample": 1.5}], "thermalSteps": [{"name": "Step", "temp": 95, "duration": "30s", "cycles": 1}]}]. Text: ${text}`;
            
            const results = await callGemini(prompt, true);
            if (results && Array.isArray(results)) {
                results.forEach(p => {
                    p.id = 'p' + Date.now() + Math.random();
                    p.numSamples = 1;
                    state.protocols.push(p);
                });
                saveToLocal();
                alert("Imported Successfully!");
                showPage('dashboard');
            } else {
                alert("AI failed to extract. Try clearer text.");
            }
            state.isAILoading = false;
            render();
        }

        function createNewProtocol() {
            const newP = { ...defaultProtocol, id: 'p' + Date.now(), title: 'New Experiment' };
            state.protocols.push(newP);
            saveToLocal();
            editProtocol(newP.id);
        }

        function deleteProtocol(id) {
            if (confirm("Delete?")) {
                state.protocols = state.protocols.filter(p => p.id !== id);
                saveToLocal();
                render();
            }
        }

        function editProtocol(id) {
            state.editingProtocol = JSON.parse(JSON.stringify(state.protocols.find(p => p.id === id)));
            state.currentPage = 'editor';
            render();
        }

        // --- Load App ---
        window.onload = () => { loadFromLocal(); render(); };
    </script>
</body>
</html>
